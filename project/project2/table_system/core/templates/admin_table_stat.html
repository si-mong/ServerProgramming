{% extends "base.html" %}
{% block title %}테이블 관리{% endblock %}
{% block content %}
<div class="admin-page">
  <div class="page-header">
    <h1>테이블 관리</h1>
    <a href="/admin/table.html?action=add&tid=" class="btn btn-primary" id="addTableBtn">
      <span>+</span> ADD TABLE
    </a>
  </div>

  <form method="get" action="/admin/table.html" id="tableForm" class="action-bar">
    <label for="action">Action:</label>
    <select name="action" id="action" required>
      <option value="">---------</option>
      <option value="del">선택한 테이블 삭제</option>
    </select>
    <button type="submit" class="btn btn-secondary">Go</button>
    <span class="selected-count" id="selectedCount">0 of {{ tables|length }} selected</span>
  </form>

  <div class="list-container">
    <table class="data-table">
      <thead>
        <tr>
          <th class="checkbox-col">
            <input type="checkbox" id="selectAll" />
          </th>
          <th>TABLE ID</th>
          <th class="amount-col">총 주문 금액(누적)</th>
          <th class="receipt-col">영수증</th>
        </tr>
      </thead>
      <tbody>
        {% for tid, data in tables.items %}
        <tr>
          <td class="checkbox-col">
            <input type="checkbox" name="table_check" value="{{ tid }}" class="table-checkbox" />
          </td>
          <td class="table-name">{{ tid }}</td>
          <td class="amount">{{ data.total_amount|floatformat:0 }}원</td>
          <td class="receipt">
            <a href="/customer/order.html?action=stat&tid={{ tid }}" class="receipt-link">영수증 보기</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="empty-message">등록된 테이블이 없습니다.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="page-footer">
    <span class="item-count">{{ tables|length }} tables</span>
  </div>
</div>

<!-- 테이블 추가 모달 -->
<div id="addTableModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>테이블 추가</h2>
    <form method="get" action="/admin/table.html" class="modal-form">
      <input type="hidden" name="action" value="add" />
      <div class="form-group">
        <label for="tableId">테이블 ID:</label>
        <input type="text" name="tid" id="tableId" required placeholder="테이블 ID를 입력하세요" />
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">추가</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
      </div>
    </form>
  </div>
</div>

<script>
// 전체 선택/해제
document.getElementById('selectAll')?.addEventListener('change', function(e) {
  const checkboxes = document.querySelectorAll('.table-checkbox');
  checkboxes.forEach(cb => cb.checked = e.target.checked);
  updateSelectedCount();
});

// 개별 체크박스 변경 시
document.querySelectorAll('.table-checkbox').forEach(cb => {
  cb.addEventListener('change', updateSelectedCount);
});

function updateSelectedCount() {
  const checked = document.querySelectorAll('.table-checkbox:checked').length;
  const total = document.querySelectorAll('.table-checkbox').length;
  document.getElementById('selectedCount').textContent = `${checked} of ${total} selected`;
  
  // 전체 선택 체크박스 상태 업데이트
  const selectAll = document.getElementById('selectAll');
  if (selectAll) {
    selectAll.checked = checked === total && total > 0;
    selectAll.indeterminate = checked > 0 && checked < total;
  }
}

// 테이블 추가 모달
document.getElementById('addTableBtn')?.addEventListener('click', function(e) {
  e.preventDefault();
  document.getElementById('addTableModal').style.display = 'block';
});

document.querySelector('.close')?.addEventListener('click', closeModal);

function closeModal() {
  document.getElementById('addTableModal').style.display = 'none';
}

window.onclick = function(event) {
  const modal = document.getElementById('addTableModal');
  if (event.target == modal) {
    closeModal();
  }
}

// 폼 제출 시 선택된 테이블들을 처리
document.getElementById('tableForm')?.addEventListener('submit', function(e) {
  const action = document.getElementById('action').value;
  if (action === 'del') {
    const checked = Array.from(document.querySelectorAll('.table-checkbox:checked')).map(cb => cb.value);
    if (checked.length === 0) {
      e.preventDefault();
      alert('삭제할 테이블을 선택하세요.');
      return false;
    }
    // 첫 번째 선택된 테이블을 삭제 (여러 개 선택 시 첫 번째만)
    const form = e.target;
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'tid';
    input.value = checked[0];
    form.appendChild(input);
    // action은 이미 select에 있음
  }
});

// 초기 카운트 업데이트
updateSelectedCount();
</script>
{% endblock %}

